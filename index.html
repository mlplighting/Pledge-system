<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pledges Live Overlay</title>
  <style>
    :root{
      /* Chroma green for keying; adjust if your keyer prefers a different hue */
      --chroma: #00b140;
      --darkBlue: #0b1a3a;
      --gold: #d8b34b;
      --gold-strong: #f3d272;
      --glass: rgba(255,255,255,0.06);
    }

    /* ==== Stage (green screen) ==== */
    html, body {
      height: 100%; margin: 0; overflow: hidden;
      background: var(--chroma);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap { position: relative; width: 100%; height: 100%; }

    /* ==== Total (border only around the number) ==== */
    .totalBar {
      position: absolute; top: 2vh; left: 50%; transform: translateX(-50%);
      width: min(92vw, 1400px); text-align: center;
    }
    .totalLabel {
      color: var(--gold); opacity: .95; letter-spacing: .06em;
      font-size: clamp(14px, 2.2vh, 22px); margin-bottom: .6vh;
      text-transform: uppercase;
    }
    .totalValue {
      display: inline-block;
      padding: .8vh 1.6vw;
      background: var(--darkBlue);
      color: var(--gold-strong);
      font-weight: 900;
      font-size: clamp(28px, 5.4vh, 76px);
      border: 3px solid var(--gold);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.35), inset 0 0 20px rgba(255,255,255,.05);
    }

    /* ==== On-air spotlight card (center) ==== */
    .onAir {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%);
      min-width: min(62vw, 980px); max-width: min(80vw, 1200px);
      text-align: center; color: var(--gold-strong);
      background: var(--darkBlue);
      border: 3px solid var(--gold);
      border-radius: 16px;
      padding: 2.6vh 3vw;
      box-shadow: 0 16px 40px rgba(0,0,0,.45), inset 0 0 18px rgba(255,255,255,.05);
      display: none;
    }
    .pledgeName { font-size: clamp(20px, 3.6vh, 44px); font-weight: 800; }
    .pledgeAmount { font-size: clamp(18px, 3.2vh, 38px); font-weight: 700; margin-top: .5vh; }

    /* ==== Recent columns (left/right); NO wide row border ==== */
    .col {
      position: absolute; width: min(32vw, 520px);
      bottom: 4vh; display: flex; flex-direction: column; gap: .8vh;
    }
    .col.left { left: 3vw; align-items: flex-start; }
    .col.right { right: 3vw; align-items: flex-end; }

    .chip {
      max-width: 100%;
      background: var(--darkBlue);
      border: 2px solid var(--gold);
      border-radius: 10px;
      color: var(--gold-strong);
      font-weight: 700;
      padding: .6vh .9vw;
      box-shadow: 0 6px 16px rgba(0,0,0,.35), inset 0 0 12px rgba(255,255,255,.05);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* Simple fades for the on-air card */
    .fade-in { animation: fadeIn .35s ease-out both; }
    .fade-out { animation: fadeOut .25s ease-in both; }
    @keyframes fadeIn { from { opacity: 0; transform: translate(-50%,-53%); } to { opacity: 1; transform: translate(-50%,-50%); } }
    @keyframes fadeOut { from { opacity: 1; transform: translate(-50%,-50%); } to { opacity: 0; transform: translate(-50%,-47%); } }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Total -->
    <div class="totalBar">
      <div class="totalLabel">Total Pledged</div>
      <div class="totalValue" id="totalAmount">$0</div>
    </div>

    <!-- Center name for 15s -->
    <div class="onAir" id="onAirCard">
      <div class="pledgeName" id="pledgeName"></div>
      <div class="pledgeAmount" id="pledgeAmount"></div>
    </div>

    <!-- Recent columns (5 per side) -->
    <div class="col left" id="colLeft"></div>
    <div class="col right" id="colRight"></div>
  </div>

  <script>
    /* ===== CONFIG ===== */
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbyap4VxcOBZ-0PwQuwgEaG3OeFNEly2EwFROUxU_2x8hU00xIqR7l-zMk_8j0zrDvDc9g/exec';
    const POLL_MS = 5000;      // poll every 5s
    const ONAIR_MS = 15000;    // on-air duration per pledge
    const LEFT_MAX = 5;        // left column size
    const RIGHT_MAX = 5;       // right column size

    /* ===== STATE ===== */
    let seen = new Set();      // ids we've processed
    let queue = [];            // new pledges awaiting on-air
    let showing = false;
    let currentTotal = 0;
    let initialized = false;
    let recentList = [];       // newest-first; max 10 (5 left + 5 right)

    /* ===== DOM ===== */
    const totalEl = document.getElementById('totalAmount');
    const onAir = document.getElementById('onAirCard');
    const nameEl = document.getElementById('pledgeName');
    const amtEl = document.getElementById('pledgeAmount');
    const colLeft = document.getElementById('colLeft');
    const colRight = document.getElementById('colRight');

    const usd0 = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });

    /* ===== HELPERS ===== */
    function normalize(data) {
      const rows = Array.isArray(data?.pledges) ? data.pledges
                 : Array.isArray(data?.data) ? data.data
                 : Array.isArray(data) ? data : [];
      return rows.map((r, i) => {
        const id = String(r.id ?? `${r.name}|${r.amount}|${r.timestamp}|${i}`);
        const name = String(r.name ?? r.Name ?? 'Anonymous').trim() || 'Anonymous';
        const amount = Number(String(r.amount ?? r.Amount ?? 0).replace(/[^\d.]/g,'')) || 0;
        const ts = Date.parse(r.timestamp ?? r.Timestamp ?? Date.now()) || Date.now();
        return { id, name, amount, ts };
      }).filter(p => p.amount > 0).sort((a,b)=>a.ts-b.ts);
    }

    function renderTotal(val){ totalEl.textContent = usd0.format(Math.round(val)); }
    function animateTotal(from, to, ms=800){
      if(from===to) return;
      const t0 = performance.now();
      const tick = (t)=>{
        const p = Math.min(1,(t - t0)/ms);
        const v = from + (to-from)*p;
        renderTotal(v);
        if(p<1) requestAnimationFrame(tick); else renderTotal(to);
      };
      requestAnimationFrame(tick);
    }

    /* Layout recent into two columns, newest at top of each column.
       We keep recentList length <= 10 (LEFT_MAX + RIGHT_MAX). */
    function renderRecent(){
      colLeft.innerHTML = '';
      colRight.innerHTML = '';
      // Split alternating into left/right for a balanced look
      const leftItems = [];
      const rightItems = [];
      recentList.slice(0, LEFT_MAX + RIGHT_MAX).forEach((p, idx)=>{
        (idx % 2 === 0 ? leftItems : rightItems).push(p);
      });
      leftItems.slice(0, LEFT_MAX).forEach(p=>colLeft.appendChild(makeChip(p)));
      rightItems.slice(0, RIGHT_MAX).forEach(p=>colRight.appendChild(makeChip(p)));
    }

    function makeChip({name, amount}){
      const el = document.createElement('div');
      el.className = 'chip';
      // No dash between name and amount:
      el.textContent = `${name} ${usd0.format(amount)}`;
      return el;
    }

    function addRecentTop(p){
      // newest first
      recentList.unshift(p);
      // cap at 10
      if (recentList.length > (LEFT_MAX + RIGHT_MAX)) {
        recentList.length = (LEFT_MAX + RIGHT_MAX);
      }
      renderRecent();
    }

    /* ===== POLLING ===== */
    async function poll(){
      try{
        const res = await fetch(ENDPOINT, { cache: 'no-store' });
        const data = await res.json();
        const pledges = normalize(data);

        if(!initialized){
          // baseline totals + seed recent (last 10)
          pledges.forEach(p=>seen.add(p.id));
          currentTotal = pledges.reduce((s,p)=>s+p.amount, 0);
          renderTotal(currentTotal);
          recentList = pledges.slice(- (LEFT_MAX + RIGHT_MAX)).reverse(); // newest first
          renderRecent();
          initialized = true;
          return;
        }

        // enqueue only new ones
        const newOnes = pledges.filter(p=>!seen.has(p.id));
        newOnes.forEach(p=>{ seen.add(p.id); queue.push(p); });
        kickLoop();
      }catch(e){
        // optional: console.error(e);
      }
    }

    /* ===== ON-AIR LOOP ===== */
    function kickLoop(){
      if(showing || queue.length===0) return;
      const next = queue.shift();
      showing = true;

      nameEl.textContent = next.name;
      amtEl.textContent = usd0.format(next.amount);

      onAir.classList.remove('fade-out');
      onAir.style.display = 'block';
      onAir.classList.add('fade-in');

      const target = currentTotal + next.amount;
      animateTotal(currentTotal, target, 900);
      currentTotal = target;

      setTimeout(()=>{
        onAir.classList.remove('fade-in');
        onAir.classList.add('fade-out');
        setTimeout(()=>{
          onAir.style.display = 'none';
          addRecentTop(next);   // move to columns
          showing = false;
          if(queue.length>0) kickLoop();
        }, 260);
      }, ONAIR_MS);
    }

    /* ===== START ===== */
    renderTotal(0);
    poll();
    setInterval(poll, POLL_MS);
  </script>
</body>
</html>
