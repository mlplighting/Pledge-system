<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pledges Live Overlay</title>
  <style>
    /* ===== Layout (transparent overlay) ===== */
    html, body {
      height: 100%;
      margin: 0;
      background: transparent; /* keep overlay see-through */
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #fff;
      overflow: hidden;
    }
    .wrap {
      position: relative;
      height: 100%;
      width: 100%;
      padding: 3vh 4vw;
      box-sizing: border-box;
    }

    /* ===== Total bar ===== */
    .totalBar {
      position: absolute;
      top: 2vh;
      left: 50%;
      transform: translateX(-50%);
      width: min(92vw, 1400px);
      text-align: center;
      padding: 1.2vh 2vw;
      border-radius: 12px;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .totalLabel { font-size: clamp(14px, 2.2vh, 22px); opacity: 0.85; letter-spacing: 0.06em; }
    .totalValue { font-weight: 800; font-size: clamp(28px, 5.2vh, 72px); }

    /* ===== On-air card (the 15s spotlight) ===== */
    .onAir {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: min(80vw, 1200px);
      padding: 3vh 3vw;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.3));
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      color: #fff;
      text-align: center;
      display: none;
    }
    .pledgeName { font-size: clamp(18px, 3.4vh, 42px); font-weight: 700; }
    .pledgeAmount { font-size: clamp(18px, 3.2vh, 38px); font-weight: 600; opacity: 0.95; margin-top: 0.6vh; }

    /* ===== Recent pledges row ===== */
    .recentPledges {
      position: absolute;
      bottom: 2vh;
      left: 50%;
      transform: translateX(-50%);
      width: min(92vw, 1400px);
      padding: 1.2vh 2vw;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      border-radius: 10px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
      color: #fff;
      font-size: clamp(14px, 2.5vh, 22px);
      display: flex;
      gap: 1.2rem;
      flex-wrap: nowrap;
      overflow: hidden;
      align-items: center;
    }
    .recentPledges .tag {
      white-space: nowrap;
      padding: 0.4em 0.7em;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.18);
      font-weight: 600;
    }

    /* ===== Simple fades ===== */
    .fade-in { animation: fadeIn 350ms ease-out forwards; }
    .fade-out { animation: fadeOut 250ms ease-in forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -53%); } to { opacity: 1; transform: translate(-50%, -50%); } }
    @keyframes fadeOut { from { opacity: 1; transform: translate(-50%, -50%); } to { opacity: 0; transform: translate(-50%, -47%); } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="totalBar">
      <div class="totalLabel">Total Pledged</div>
      <div class="totalValue" id="totalAmount">$0</div>
    </div>

    <div class="onAir" id="onAirCard">
      <div class="pledgeName" id="pledgeName"></div>
      <div class="pledgeAmount" id="pledgeAmount"></div>
    </div>

    <div class="recentPledges" id="recentPledges">
      <!-- Recent pledge chips appear here -->
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbyap4VxcOBZ-0PwQuwgEaG3OeFNEly2EwFROUxU_2x8hU00xIqR7l-zMk_8j0zrDvDc9g/exec';
    const POLL_MS = 5000;       // poll the feed every 5s
    const ONAIR_MS = 15000;     // each pledge displays ~15s
    const RECENT_LIMIT = 8;     // how many chips to keep visible

    // ===== STATE =====
    let seen = new Set();       // ids of pledges we've counted
    let queue = [];             // new pledges waiting to be shown
    let showing = false;        // is a pledge currently on-air?
    let currentTotal = 0;       // dollar total displayed
    let initialized = false;    // after first load we only show new items

    // ===== DOM =====
    const totalEl = document.getElementById('totalAmount');
    const onAir = document.getElementById('onAirCard');
    const nameEl = document.getElementById('pledgeName');
    const amtEl  = document.getElementById('pledgeAmount');
    const recentEl = document.getElementById('recentPledges');

    const usd = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });

    // Robustly read any likely field name from Apps Script JSON
    function normalize(data) {
      // Accept a few possible envelopes
      let rows = Array.isArray(data) ? data
               : Array.isArray(data?.data) ? data.data
               : Array.isArray(data?.pledges) ? data.pledges
               : [];

      return rows.map((r, i) => {
        const name = r.Name ?? r.name ?? r.FullName ?? r.fullName ?? r.donor ?? r.Donor ?? 'Anonymous';
        const amtRaw = r.Amount ?? r.amount ?? r.Pledge ?? r.pledge ?? r.total ?? r.Total ?? r.Sum ?? 0;
        const tsRaw = r.Timestamp ?? r.timestamp ?? r.Time ?? r.time ?? r.Date ?? r.date ?? null;

        // Parse number from strings like "$1,234" etc.
        const amount = Number(String(amtRaw).replace(/[^\d.]/g, '')) || 0;

        // derive a stable-ish id
        const ts = tsRaw ? Date.parse(tsRaw) || tsRaw : '';
        const id = (r.Id ?? r.id ?? `${name}|${amount}|${ts}|${i}`).toString();

        return { id, name: String(name).trim() || 'Anonymous', amount, ts: ts || Date.now() };
      }).filter(p => p.amount > 0);
    }

    function renderTotal(val) { totalEl.textContent = usd.format(Math.round(val)); }

    function animateTotal(from, to, ms = 800) {
      if (from === to) return;
      const start = performance.now();
      function step(t) {
        const p = Math.min(1, (t - start) / ms);
        const value = from + (to - from) * p;
        renderTotal(value);
        if (p < 1) requestAnimationFrame(step);
        else renderTotal(to);
      }
      requestAnimationFrame(step);
    }

    function addRecentChip({name, amount}) {
      const chip = document.createElement('span');
      chip.className = 'tag';
      chip.textContent = `${name} â€” ${usd.format(amount)}`;
      recentEl.prepend(chip);
      // trim
      while (recentEl.children.length > RECENT_LIMIT) {
        recentEl.lastElementChild?.remove();
      }
    }

    function primeRecent(list) {
      // Seed recent with last few (without on-airing them)
      const lastFew = list.slice(-RECENT_LIMIT);
      lastFew.forEach(p => {
        addRecentChip(p);
      });
    }

    async function poll() {
      try {
        const res = await fetch(ENDPOINT, { cache: 'no-store' });
        const data = await res.json();

        const pledges = normalize(data).sort((a,b) => (a.ts> b.ts ? 1 : -1));

        // On first load: set total to all seen, seed recent, mark all as seen.
        if (!initialized) {
          pledges.forEach(p => seen.add(p.id));
          const baseline = pledges.reduce((s,p) => s + p.amount, 0);
          currentTotal = baseline;
          renderTotal(currentTotal);
          primeRecent(pledges);
          initialized = true;
          return;
        }

        // After init: queue only new ones
        const newOnes = pledges.filter(p => !seen.has(p.id));
        newOnes.forEach(p => {
          seen.add(p.id);
          queue.push(p);
        });

        kickLoop();
      } catch (e) {
        // Silent retry; optionally you could log to console
        // console.error('Poll error', e);
      }
    }

    function kickLoop() {
      if (showing || queue.length === 0) return;

      const next = queue.shift();
      showing = true;

      // Fill card
      nameEl.textContent = next.name;
      amtEl.textContent  = usd.format(next.amount);

      // Show card with fade
      onAir.classList.remove('fade-out');
      onAir.style.display = 'block';
      onAir.classList.add('fade-in');

      // Animate total up
      const target = currentTotal + next.amount;
      animateTotal(currentTotal, target, 900);
      currentTotal = target;

      // After ONAIR_MS, hide, add to recent, then continue
      setTimeout(() => {
        onAir.classList.remove('fade-in');
        onAir.classList.add('fade-out');
        setTimeout(() => {
          onAir.style.display = 'none';
          addRecentChip(next);
          showing = false;
          // If more queued, immediately continue
          if (queue.length > 0) kickLoop();
        }, 260); // match fade-out duration
      }, ONAIR_MS);
    }

    // Start
    renderTotal(0);
    poll(); // initial
    setInterval(poll, POLL_MS);
  </script>
</body>
</html>
